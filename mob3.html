<!DOCTYPE html>
<html lang="ka">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SHARDNET v12 // REAL-NET</title>
    <link rel="manifest" href="manifest.json">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <style>
        body { background: #010204; color: #4ade80; font-family: monospace; -webkit-tap-highlight-color: transparent; }
        .mobile-card { background: #0a0f19; border: 1px solid #1e293b; border-radius: 12px; }
        #reader { width: 100%; border-radius: 12px; overflow: hidden; background: #000; aspect-ratio: 1/1; }
        .btn-active:active { transform: scale(0.98); opacity: 0.8; }
    </style>
</head>
<body class="p-4 flex flex-col h-screen overflow-hidden">

    <header class="flex justify-between items-center mb-4 border-b border-slate-900 pb-2">
        <div class="flex items-center gap-2">
            <div id="statusDot" class="w-3 h-3 rounded-full bg-red-600"></div>
            <span class="text-[10px] font-bold uppercase">Shardnet Real-Net</span>
        </div>
        <div id="netType" class="text-[8px] opacity-40 uppercase">Awaiting Connection</div>
    </header>

    <div class="mobile-card p-3 mb-4">
        <label class="text-[8px] uppercase opacity-40 block mb-1">Your ID (Tap to Copy)</label>
        <code id="myId" class="text-[10px] text-white break-all bg-black/50 p-2 block rounded border border-green-900/20 active:bg-green-500 active:text-black cursor-pointer" onclick="copyId()">CONNECTING...</code>
    </div>

    <div class="space-y-3">
        <div class="grid grid-cols-2 gap-2">
            <button onclick="showMyQR()" class="bg-green-900/20 border border-green-500/30 p-3 rounded-xl text-[10px] font-bold uppercase btn-active text-green-400">Show QR</button>
            <button onclick="startScanner()" class="bg-blue-900/20 border border-blue-500/30 p-3 rounded-xl text-[10px] font-bold uppercase btn-active text-blue-400">Scan Peer</button>
        </div>
        
        <div id="reader" class="hidden border border-slate-700"></div>
        
        <input type="password" id="meshKey" placeholder="üîê Encryption Key" class="w-full bg-black border border-slate-800 p-3 rounded-xl text-sm text-white outline-none focus:border-green-500">
        <input type="text" id="targetId" placeholder="üì° Partner Peer ID" class="w-full bg-black border border-slate-800 p-3 rounded-xl text-[10px] text-white outline-none focus:border-blue-500">
    </div>

    <div id="chatBox" class="flex-1 overflow-y-auto my-4 space-y-2 text-[10px] p-2 bg-black/10 border border-slate-900 rounded-xl">
        <div class="text-center opacity-20 py-4 uppercase text-[8px]">System Ready for Sharding</div>
    </div>

    <div class="pb-6">
        <div class="flex gap-2">
            <input type="file" id="fileIn" class="hidden" onchange="document.getElementById('fileLabel').innerText = this.files[0].name">
            <label for="fileIn" id="fileLabel" class="flex-1 bg-slate-900 p-4 rounded-xl text-center text-[10px] font-bold border border-slate-800 truncate px-2">üìé Select File</label>
            <button id="executeBtn" class="flex-[2] bg-green-600 text-black p-4 rounded-xl text-[10px] font-bold uppercase btn-active">Transmit</button>
        </div>
    </div>

    <div id="qrModal" class="hidden fixed inset-0 bg-black/95 z-50 flex flex-col items-center justify-center p-6" onclick="this.classList.add('hidden')">
        <div id="qrcode" class="bg-white p-4 rounded-lg"></div>
        <p class="mt-4 text-[10px] text-green-500 uppercase tracking-widest animate-pulse">Tap anywhere to close</p>
    </div>

    <script>
        // TURN ·É°·Éî·É†·Éï·Éî·É†·Éî·Éë·Éò ·É†·Éî·Éê·Éö·É£·É†·Éò ·É•·É°·Éî·Éö·É£·É†·Éò ·É¢·É†·Éê·Éú·Éñ·Éò·É¢·Éò·É°·Éó·Éï·Éò·É°
        const peer = new Peer({
            config: {
                'iceServers': [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { 
                        urls: 'turn:openrelay.metered.ca:443', 
                        username: 'openrelayproject', 
                        credential: 'openrelayproject' 
                    }
                ],
                'iceTransportPolicy': 'all'
            }
        });

        let scanner = null;
        let fileBuffer = {};

        peer.on('open', id => {
            document.getElementById('myId').textContent = id;
            document.getElementById('statusDot').className = "w-3 h-3 rounded-full bg-green-500 shadow-[0_0_10px_#4ade80]";
            document.getElementById('netType').textContent = "Relay Network Ready";
        });

        function copyId() {
            const id = document.getElementById('myId').innerText;
            if(id !== "CONNECTING...") {
                navigator.clipboard.writeText(id);
                alert("ID ·Éì·Éê·Éô·Éù·Éû·Éò·É†·Éî·Éë·É£·Éö·Éò·Éê!");
            }
        }

        async function startScanner() {
            const readerDiv = document.getElementById('reader');
            readerDiv.classList.remove('hidden');
            if (!scanner) scanner = new Html5Qrcode("reader");
            
            try {
                await scanner.start(
                    { facingMode: "environment" }, 
                    { fps: 10, qrbox: 250 }, 
                    (text) => {
                        document.getElementById('targetId').value = text;
                        scanner.stop().then(() => {
                            readerDiv.classList.add('hidden');
                        });
                    }
                );
            } catch (err) { 
                alert("·Éô·Éê·Éõ·Éî·É†·Éò·É° ·É®·Éî·É™·Éì·Éù·Éõ·Éê: ·Éì·Éê·É†·É¨·Éõ·É£·Éú·Éì·Éò·Éó ·É†·Éù·Éõ HTTPS ·É©·Éê·É†·Éó·É£·Éö·Éò·Éê."); 
                readerDiv.classList.add('hidden');
            }
        }

        function showMyQR() {
            const id = document.getElementById('myId').innerText;
            if(id === "CONNECTING...") return;
            const qrd = document.getElementById("qrcode");
            qrd.innerHTML = "";
            new QRCode(qrd, { text: id, width: 200, height: 200 });
            document.getElementById('qrModal').classList.remove('hidden');
        }

        document.getElementById('executeBtn').onclick = async () => {
            const file = document.getElementById('fileIn').files[0];
            const key = document.getElementById('meshKey').value;
            const tid = document.getElementById('targetId').value;

            if(!file || !key || !tid) return alert("·É®·Éî·Éê·Éï·É°·Éî·Éó ·Éß·Éï·Éî·Éö·Éê ·Éï·Éî·Éö·Éò!");

            const chatBox = document.getElementById('chatBox');
            chatBox.innerHTML += `<div class='text-blue-400 opacity-60'>[SYSTEM] Encrypting & Sharding...</div>`;

            const buffer = await file.arrayBuffer();
            const encrypted = CryptoJS.AES.encrypt(CryptoJS.lib.WordArray.create(buffer), key).toString();
            const hash = CryptoJS.SHA256(encrypted).toString();

            const conn = peer.connect(tid, { reliable: true });
            
            conn.on('open', () => {
                conn.send({ type: 'START', name: file.name, hash: hash, total: 16 });
                const shardSize = Math.ceil(encrypted.length / 16);
                
                for(let i=0; i<16; i++) {
                    const chunk = encrypted.substring(i * shardSize, (i + 1) * shardSize);
                    conn.send({ type: 'DATA', data: chunk, id: i });
                }
                chatBox.innerHTML += `<div class='text-right text-green-500'>‚úÖ SENT: ${file.name}</div>`;
                chatBox.scrollTop = chatBox.scrollHeight;
            });

            conn.on('error', err => alert("·Éô·Éê·Éï·É®·Éò·É†·Éò·É° ·É®·Éî·É™·Éì·Éù·Éõ·Éê: " + err));
        };

        peer.on('connection', conn => {
            conn.on('data', data => {
                const chatBox = document.getElementById('chatBox');
                if(data.type === 'START') {
                    fileBuffer = { parts: [], total: data.total, hash: data.hash, name: data.name, count: 0 };
                    chatBox.innerHTML += `<div class='text-yellow-500'>üì• RECEIVING: ${data.name}...</div>`;
                }
                if(data.type === 'DATA') {
                    fileBuffer.parts[data.id] = data.data;
                    fileBuffer.count++;
                    if(fileBuffer.count === fileBuffer.total) assemble();
                }
                chatBox.scrollTop = chatBox.scrollHeight;
            });
        });

        function assemble() {
            const fullEnc = fileBuffer.parts.join('');
            if(CryptoJS.SHA256(fullEnc).toString() !== fileBuffer.hash) {
                alert("HASH MISMATCH - ·É§·Éê·Éò·Éö·Éò ·Éì·Éê·Éñ·Éò·Éê·Éú·Éî·Éë·É£·Éö·Éò·Éê");
                return;
            }
            
            const key = document.getElementById('meshKey').value;
            try {
                const dec = CryptoJS.AES.decrypt(fullEnc, key);
                const typedArray = new Uint8Array(dec.sigBytes);
                for (let i = 0; i < dec.sigBytes; i++) {
                    typedArray[i] = (dec.words[i >>> 2] >>> (24 - (i % 4) * 8)) & 0xff;
                }
                
                const url = URL.createObjectURL(new Blob([typedArray]));
                document.getElementById('chatBox').innerHTML += `
                    <div class="p-2 border border-green-900 rounded bg-green-900/10 mt-2">
                        <span class="text-white font-bold">‚úÖ RECEIVED: ${fileBuffer.name}</span><br>
                        <a href="${url}" download="${fileBuffer.name}" class="text-green-400 underline text-[12px] block mt-1">üì• SAVE FILE</a>
                    </div>`;
            } catch(e) { 
                alert("DECRYPTION FAILED - ·É®·Éî·Éê·Éõ·Éù·É¨·Éõ·Éî·Éó ·Éû·Éê·É†·Éù·Éö·Éò"); 
            }
        }
    </script>
</body>
</html>
